on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:
# This is used to manually trigger the workflow for testing purposes

jobs:
  fetch-latest-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch latest tag from libphonenumber
        id: fetch-latest-tag
        run: |
          # Try to get latest release tag first, fallback to latest tag if no releases
          LATEST_TAG=$(curl -s https://api.github.com/repos/google/libphonenumber/releases/latest | jq -r '.tag_name' 2>/dev/null)
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            # Fallback to tags API, get the first (most recent) tag
            LATEST_TAG=$(curl -s https://api.github.com/repos/google/libphonenumber/tags | jq -r '.[0].name' 2>/dev/null)
          fi
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "Error: Could not fetch latest tag"
            exit 1
          fi
          echo "latest_tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Latest tag from libphonenumber: ${LATEST_TAG}"

      - name: Read current version
        id: read-current-version
        run: |
          CURRENT_VERSION=$(cat libphonenumber.version | tr -d '\n\r ' | sed 's/^v//')
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "Current version in libphonenumber.version: ${CURRENT_VERSION}"

      - name: Compare versions
        run: |
          LATEST_TAG="${{ steps.fetch-latest-tag.outputs.latest_tag }}"
          CURRENT_VERSION="v${{ steps.read-current-version.outputs.current_version }}"

          echo "Comparing versions:"
          echo "  Latest from libphonenumber: ${LATEST_TAG}"
          echo "  Current in libphonenumber.version: ${CURRENT_VERSION}"

          if [ "${LATEST_TAG}" != "${CURRENT_VERSION}" ]; then
            echo "⚠️ Versions differ!"
            echo "Latest available: ${LATEST_TAG}"
            echo "Current version: ${CURRENT_VERSION}"
            # Dispatch build_and_generate workflow
            gh workflow run build_and_generate --ref master -f version_number=${LATEST_TAG}
            exit 1
          else
            echo "✅ Versions match!"
            exit 0
          fi
